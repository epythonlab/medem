<!DOCTYPE html>
{% extends 'base.html' %}
<title>{% block title %}Sign in to Medem {% endblock title %}</title>
{% block body %}
<!-- Top content -->
<!-- MultiStep Form -->
<!-- <div class="img-overlay"></div> -->
<section class="container">
    <div class="row ">
        <div class="col-sm-12 col-md-4 col-lg-5 side-section">
            <div class="side-box">
                <div class="login-header">
                    <img src="static/logos/logo.ico" alt="MedEM">
                    <h2>Medem</h2>
                </div>
                <p>Please enter your details to sign in the agreement and have your own store management software.</p>
                <p class="message">
                    Not registered?
                    <a href="#" class="register submit action-button">Register now</a>
                </p>
            </div>
        </div>
        <div class="col-sm-12 col-md-5 col-lg-6 form-box">
            <!-- Registration form for new user-->
            <form id="msform" class="register-form hidden" action="/register" method="post" enctype="multipart/form-data">
                <ul id="progressbar">
                    <li class="active">Personal Details</li>
                    <li>Company address</li>
                    <li>Company Profile</li>
                </ul>
                <div class="card custom-card-border">
                    <div class="card-body">
                        <fieldset>
                            <label for="" class="form-label float-start">First name 
                                <span class="red-asterisk">*</span>
                            </label>
                            <input type="text" name="fname" class="form-control" id="fname" value="" placeholder="Enter your first name" required>
                           
                            <label for="" class="form-label float-start">Last name
                                <span class="red-asterisk">*</span>
                            </label>
                            <input type="text" name="lname" class="form-control" id="lname" value="" placeholder="Enter your last name" required> 
                            
                            <label for="" class="form-label float-start">Mobile number
                                <span class="red-asterisk">*</span>
                            </label>
                            <input type="tel" name="phone" class="form-control" placeholder="Mobile number" required>
                            
                            <label for="" class="form-label float-start">Email address
                                <span class="red-asterisk">*</span>
                            </label>
                            <input type="email" id="emailInput" name="email" class="form-control" placeholder="Email address" required>
                            <div id="emailError" style="color: red;"></div>

                            <input type="button" id="next" name="next" class="next action-button" value="Next">
                           
                        </fieldset>
                        <fieldset>
                            <!-- <h2 class="card-title">Company Profile</h2> -->
                            <label for="" class="form-label float-start">Country</label>
                            <input type="text" value="" name="country" class="form-control" id="country" placeholder="e.g Ethiopia">
                            
                            <label for="" class="form-label float-start">State
                                <span class="red-asterisk">*</span>
                            </label>
                            <input type="text" name="state" class="form-control" id="state" placeholder="e.g addis ababa" required>
                            
                            <label for="" class="form-label float-start">Sub city or Zone
                                <span class="red-asterisk">*</span>
                            </label>
                            <input type="text" name="sub_city" class="form-control" id="zone" placeholder="e.g addis ketema" required>
                            
                            <label for="" class="form-label float-start">Wereda
                                <span class="red-asterisk">*</span>
                            </label>
                            <input type="text" name="wereda" value="" class="form-control" id="wereda" placeholder="e.g 10" required>

                            <label for="" class="form-label float-start">Kebele</label>
                            <input type="text" name="kebele" class="form-control" id="kebele" placeholder="04">

                            <label for="" class="form-label float-start">House number
                                <span class="red-asterisk">*</span>
                            </label>
                            <input type="text" name="house_no" class="form-control" id="house_no" placeholder="e.g 22/140" required>

                            <input type="button" name="next" class="next action-button" value="Next">
                            <input type="button" name="previous" class="previous action-button-previous" value="Previous">
                          
                        </fieldset>
                        <fieldset>
                            <!-- <h2 class="card-title">Create your account</h2> -->
                            <label for="company_name" class="form-label float-start">Company name
                                <span class="red-asterisk">*</span>
                            </label>
                            <input type="text" name="company_name" class="form-control" placeholder="Company name" required>
                            
                            <label for="logo_name" class="form-label float-start">Company logo
                                <span class="red-asterisk">*</span>
                            </label>
                            <input type="file" name="logo" class="form-control" placeholder="upload logo" accept=".jpg, .jpeg, .png" required>
                            
                            <label for="company_name" class="form-label float-start">Company license
                                <span class="red-asterisk">*</span>
                            </label>
                            <input type="file" name="license" class="form-control" placeholder="upload renewed license" accept=".jpg, .jpeg, .png" required>
                           
                            <input type="submit" name="submit" class="submit action-button" value="Submit">
                            <input type="button" name="previous" class="previous action-button-previous" value="Previous">
                        </fieldset>
                    </div>
                </div>
                <p class="sign-message">
                    Already have an Account?
                    <a href="#" class="login">Sign in</a>
                </p>
            </form>
            <!-- Login container with login form -->
            <form method="post" id="login-form" action="/login">
                <div class="login-header">
                    <img src="static/logos/logo.ico" alt="MedEM">
                    <h2>Sign in to Medem</h2>
                </div>
                <div class="login-form">
                    <!-- Add a flash message that displays a failed login message -->
                    {% with messages = get_flashed_messages(with_categories=true) %}
                            {% if messages %}
                            {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="alert"
                            aria-label="Close"
                        ></button>
                    </div>
                    {% endfor %}
                            {% endif %}
                            {% endwith %}
                    <div class="mb-3">
                        <label for="username" class="form-label">Username or email address
                            <span class="red-asterisk">*</span>
                        </label>
                        <input type="email" class="form-control" id="username" name="username" placeholder="Enter email" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password
                            <span class="red-asterisk">*</span>
                        </label>
                        <input type="password" class="form-control" id="password" name="password" placeholder="Password" required>
                    </div>
                    <button class="btn btn-primary hover-orange" type="submit">Sign in</button>
                </div>
            </form>
        </div>
    </div>
</section>

<!-- /.MultiStep Form -->
<script>
 // JavaScript function to handle multi-step registration form
function handleMultiStepForm(nextButtonClass, previousButtonClass, submitButtonClass, progressBarId) {
    let fieldsets = document.querySelectorAll("fieldset");
    let nextButtons = document.querySelectorAll("." + nextButtonClass);
    let previousButtons = document.querySelectorAll("." + previousButtonClass);
    let submitButtons = document.querySelectorAll("." + submitButtonClass);
    let progressBarLi = document.querySelectorAll("#" + progressBarId + " li");

    // Event listener for next buttons
    nextButtons.forEach(nextButton => {
        nextButton.addEventListener("click", function() {
            let current_fs = this.parentNode;
            let next_fs = this.parentNode.nextElementSibling;
            
            // Check if the current fieldset has any required inputs that are empty
            if (!checkEmptyInputs(current_fs)) {
                console.log("Required input is empty!");
                return; // If any required input is empty, do not proceed
            } else {
                console.log("All required inputs are filled.");
            }
            
            // Activate next step on progressbar using the index of next_fs
            progressBarLi[Array.from(fieldsets).indexOf(next_fs)].classList.add("active");
            
            // Hide the current fieldset
            current_fs.style.display = "none";
            
            // Show the next fieldset
            next_fs.style.display = "block"; 
        });
    });

    // Event listener for previous buttons
    previousButtons.forEach(previousButton => {
        previousButton.addEventListener("click", function() {
            let current_fs = this.parentNode;
            let previous_fs = this.parentNode.previousElementSibling;
            
            // Activate previous step on progressbar using the index of current_fs
            progressBarLi[Array.from(fieldsets).indexOf(current_fs)].classList.remove("active");
            
            // Hide the current fieldset
            current_fs.style.display = "none";
            
            // Show the previous fieldset
            previous_fs.style.display = "block"; 
        });
    });

    // Event listener for submit buttons
    submitButtons.forEach(submitButton => {
        submitButton.addEventListener("click", function() {
            return false;
        });
    });
}

// Call the function with the appropriate parameters
handleMultiStepForm("next", "previous", "submit", "progressbar");


// Javascript function to check empty inputs
function checkEmptyInputs(fieldset) {
    let inputs = fieldset.querySelectorAll("input[required], select[required], textarea[required]");
    
    for (let i = 0; i < inputs.length; i++) {
        if (inputs[i].value.trim() === "") {
            // Display error message
            inputs[i].insertAdjacentHTML('afterend', '<div class="error-message float-end" style="color:red;">Please fill the required field!</div>');
            document.getElementById('emailError').textContent = "";
            return false; // Stop checking further inputs
        } else {
            // Remove error message if exists
            let errorMessage = inputs[i].nextElementSibling;
            if (errorMessage && errorMessage.classList.contains('error-message')) {
                errorMessage.remove();
            }
        }
    }
    return true; // All required inputs are filled
}

//<!-- javascript to handle the login and register form in the same page -->
document.addEventListener("DOMContentLoaded", function() {
    const registerForm = document.querySelector(".register-form");
    const loginForm = document.querySelector("#login-form");

    const registerButton = document.querySelector(".register");
    const loginButton = document.querySelector(".login");
    
    // Function to hide the login form and show the register form
    function showRegisterForm() {
        registerForm.classList.remove("hidden");
        document.title = "Register new user";
        loginForm.classList.add("hidden");
    }

    // Function to hide the register form and show the login form
    function showLoginForm() {
        loginForm.classList.remove("hidden");
        document.title = "Sign in to Medem"; // update the title of each form
        registerForm.classList.add("hidden");
    }

    // Add click event listeners to the register and login buttons
    registerButton.addEventListener("click", showRegisterForm);
    loginButton.addEventListener("click", showLoginForm);
});

// JavaScript function to check and validate the email address already registered using AJAX
function validateEmail(emailInputId, emailErrorId, nextButtonId) {
    var emailInput = document.getElementById(emailInputId);
    var emailError = document.getElementById(emailErrorId);
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    var nextButton = document.getElementById(nextButtonId);
  
    emailInput.addEventListener('input', function() {
        var email = this.value;
  
        if (emailRegex.test(email)) {
            // Send an AJAX request to check if the email exists
            fetch('/check_email?email=' + encodeURIComponent(email))
                .then(response => response.json())
                .then(data => {
                    if (data.exists) {
                        // Disable submit button if validation fails
                        nextButton.setAttribute("disabled", "disabled");
                        emailError.textContent = "Email already registered! Please reset your password or use a different email.";
                       
                    } else {
                        emailError.textContent = "";
                        nextButton.disabled = false;
                    }
                });
        } else {
            emailError.textContent = "Please enter a valid email address.";
            // Disable submit button by default
            document.getElementById("next").setAttribute("disabled", "disabled");
        }
    });
  }
  
  // Call the function with the appropriate IDs
  validateEmail('emailInput', 'emailError', 'next');
  

</script>

<!-- add the script files in the body of every html content -->
<!-- <script src="{{ url_for('static', filename='js/script.js') }}"></script> -->
{% endblock body %}
